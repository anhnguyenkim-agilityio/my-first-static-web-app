trigger:
  branches:
    include:
      - develop
      - staging
      - main

pr:
  branches:
    include:
      - "*"

pool:
  name: Default

variables:
  - group: env-vars

  - name: env
    value: 'dev'   # default fallback

  - ${{ if eq(variables['Build.SourceBranchName'], 'develop') }}:
    - name: env
      value: 'dev'

  - ${{ if eq(variables['Build.SourceBranchName'], 'staging') }}:
    - name: env
      value: 'stag'

  - ${{ if eq(variables['Build.SourceBranchName'], 'main') }}:
    - name: env
      value: 'prod'

stages:
  - stage: Test
    displayName: Run Tests
    condition: or(
        eq(variables['Build.Reason'], 'PullRequest'),
        eq(variables['Build.SourceBranchName'], 'develop'),
        eq(variables['Build.SourceBranchName'], 'staging'),
        eq(variables['Build.SourceBranchName'], 'main')
      )
    jobs:
      - job: RunTests
        steps:
          - bash: |
              echo "Running tests..."
            displayName: "Run Unit/Integration Tests"

  - stage: Deploy
    displayName: "Deploy Static Web App to $(env)"
    dependsOn: Test
    condition: |
      and(
        succeeded(),
        ne(variables['Build.Reason'], 'PullRequest'),
        in(variables['Build.SourceBranchName'], 'develop', 'staging', 'main')
      )
    jobs:
      - deployment: DeployApp
        displayName: "Deploy Static Web App to $(env)"
        environment: $(env)

        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                # Set environment-specific token based on branch
                - script: |
                    if [ "$(env)" == "dev" ]; then
                      echo "##vso[task.setvariable variable=ENV_TOKEN]$(dev-swa-deployment-token)"
                    elif [ "$(env)" == "stag" ]; then
                      echo "##vso[task.setvariable variable=ENV_TOKEN]$(stag-swa-deployment-token)"
                    elif [ "$(env)" == "prod" ]; then
                      echo "##vso[task.setvariable variable=ENV_TOKEN]$(prod-swa-deployment-token)"
                    fi
                  displayName: "Select environment token"

                # Build & Deploy
                - task: AzureStaticWebApp@0
                  displayName: "Build and Deploy SWA"
                  inputs:
                    azure_static_web_apps_api_token: $(ENV_TOKEN)
                    app_location: "./src"
                    output_location: "."

  - stage: Notify
    dependsOn: Deploy
    condition: always()
    jobs:
      - job: CallFunction
        steps:
          - bash: |
              FUNCTION_URL="https://slack-notify-func.azurewebsites.net/api/slack_notify_func?code=$(dev-slack-noti-func)"

              STATE="${AGENT_JOBSTATUS:-Failed}"
              echo "Deploy stage status: $STATE"

              PAYLOAD=$(jq -n \
                --arg pipeline "dratinifrontend" \
                --arg state "$STATE" \
                --arg branch "$(Build.SourceBranchName)" \
                '{detail: {pipeline: $pipeline, state: $state, branch: $branch}}')

              curl -X POST -H "Content-Type: application/json" -d "$PAYLOAD" "$FUNCTION_URL"
            displayName: "Trigger Slack Func (success/fail)"